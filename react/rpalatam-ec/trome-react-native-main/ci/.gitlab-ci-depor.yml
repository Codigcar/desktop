depor:android:firebase:
  extends: .publish_android_job
  stage: firebase_distribution
  variables:
    ANDROID_SIGN_CONFIG: 'android'
    ANDROID_SIGN_CONFIG_ALIAS: 'androiddebugkey'
    APP_BRAND: 'depor'
    APP_PLATFORM: 'android'
  script:
    - bundle exec fastlane android buildDebug
    - bundle exec fastlane android distribute
    - bundle exec fastlane android upload_crashlytics_symbols
    - PLATFORM=android bash util/task-comment.sh

depor:ios:firebase:
  extends: .publish_ios_job
  stage: firebase_distribution
  variables:
    APP_BRAND: 'depor'
    APP_PLATFORM: 'ios'
  script:
    - bundle exec fastlane ios buildDebug
    - bundle exec fastlane ios distribute
    - PLATFORM=ios bash util/task-comment.sh
    - PLATFORM=ios node util/app-size-report.mjs
  artifacts:
    paths:
      - ios/build/app-thinning.plist
      - ios/build/*.txt
    expire_in: 1 week
    when: on_success

depor:playstore:distribution:
  extends: .publish_android_job
  stage: store_internal_distribution
  variables:
    ANDROID_SIGN_CONFIG: $ANDROID_SIGN_CONFIG_EEEC
    ANDROID_SIGN_CONFIG_ALIAS: $ANDROID_SIGN_CONFIG_EEEC
    APP_BRAND: 'depor'
    APP_PLATFORM: 'android'
  script:
    - bundle exec fastlane android buildRelease
    - bundle exec fastlane android internal
    - bundle exec fastlane android upload_crashlytics_symbols

depor:appgallery:distribution:
  extends: .publish_android_job
  stage: store_internal_distribution
  variables:
    ANDROID_SIGN_CONFIG: $ANDROID_SIGN_CONFIG_EEEC
    ANDROID_SIGN_CONFIG_ALIAS: $ANDROID_SIGN_CONFIG_EEEC
    APP_BRAND: 'depor'
    APP_PLATFORM: 'android'
    HMS_AVAILABLE: 'true'
  script:
    - yarn add @hmscore/react-native-hms-analytics@6.3.2-300
    - echo "export { default } from '@hmscore/react-native-hms-analytics'" > src/modules/hms-analytics.ts
    - bundle exec fastlane android buildRelease
    - bundle exec fastlane android upload_to_appgallery

depor:testflight:distribution:
  extends: .publish_ios_job
  stage: store_internal_distribution
  variables:
    APP_BRAND: 'depor'
    APP_PLATFORM: 'ios'
  script:
    - bundle exec fastlane ios buildRelease
    - bundle exec fastlane ios internal --verbose

depor:playstore:review:
  extends: .review_playstore_job
  variables:
    PACKAGE_NAME: 'com.eeec.depor'

depor:appgallery:review:
  extends: .review_appgallery_job
  variables:
    HUAWEI_APP_ID: '102783043'

depor:appstore:review:
  extends: .review_appstore_job
  variables:
    APP_IDENTIFIER: 'com.eeec.Depor'
    GIT_STRATEGY: none

depor:android:release:
  extends: .release_job
  dependencies:
    - depor:playstore:review
  variables:
    APP_BRAND: 'depor'
    APP_PLATFORM: 'android'

depor:ios:release:
  extends: .release_job
  dependencies:
    - depor:appstore:review
  variables:
    APP_BRAND: 'depor'
    APP_PLATFORM: 'ios'
